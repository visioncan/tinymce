tinymce.PluginManager.add("media",function(e,t){var i=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];function r(e){if(e.indexOf(".mp3")!=-1){return"audio/mpeg"}if(e.indexOf(".wav")!=-1){return"audio/wav"}if(e.indexOf(".mp4")!=-1){return"video/mp4"}if(e.indexOf(".webm")!=-1){return"video/webm"}if(e.indexOf(".ogg")!=-1){return"video/ogg"}if(e.indexOf(".swf")!=-1){return"application/x-shockwave-flash"}return""}function a(){var t,i,r,a;function u(e){var a,o,c,n;a=t.find("#width")[0];o=t.find("#height")[0];c=a.value();n=o.value();if(t.find("#constrain")[0].checked()&&i&&r&&c&&n){if(e.control==a){n=Math.round(c/i*n);o.value(n)}else{c=Math.round(n/r*c);a.value(c)}}i=c;r=n}a=s(e.selection.getNode());i=a.width;r=a.height;t=e.windowManager.open({title:"Insert/edit video",data:a,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(n(this.next().find("#embed").value()))},items:[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:true,label:"Source"},{name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"},{name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"},{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:u},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:u},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(c(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:o(),multiline:true,label:"Source"}]}],onSubmit:function(){e.insertContent(c(this.toJSON()))}})}function o(){var t=e.selection.getNode();if(t.getAttribute("data-mce-object")){return e.selection.getContent()}}function c(a){var o="";if(!a.source1){tinymce.extend(a,n(a.embed));if(!a.source1){return""}}a.source1=e.convertURL(a.source1,"source");a.source2=e.convertURL(a.source2,"source");a.source1mime=r(a.source1);a.source2mime=r(a.source2);a.poster=e.convertURL(a.poster,"poster");a.flashPlayerUrl=e.convertURL(t+"/moxieplayer.swf","movie");if(a.embed){o=u(a.embed,a,true)}else{tinymce.each(i,function(e){var t,i,r;if(t=e.regex.exec(a.source1)){r=e.url;for(i=0;t[i];i++){r=r.replace("$"+i,function(){return t[i]})}a.source1=r;a.type=e.type;a.width=e.w;a.height=e.h}});a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(t,i){a[i]=e.dom.encode(t)});if(a.type=="iframe"){o+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"></iframe>'}else if(a.source1mime=="application/x-shockwave-flash"){o+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">';if(a.source1.indexOf(".swf")!==-1){o+='<param name="src" value="'+a.source1+'" />'}if(a.poster){o+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'}o+="</object>"}else if(a.source1mime.indexOf("audio")!=-1){if(e.settings.audio_template_callback){o=e.settings.audio_template_callback(a)}else{o+='<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"}}else{if(e.settings.video_template_callback){o=e.settings.video_template_callback(a)}else{o='<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n'+'<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}}}return o}function n(e){var t={};new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:"script,noscript",start:function(e,i){if(!t.source1&&e=="param"){t.source1=i.map.movie}if(e=="iframe"||e=="object"||e=="embed"||e=="video"||e=="audio"){t=tinymce.extend(i.map,t)}if(e=="source"){if(!t.source1){t.source1=i.map.src}else if(!t.source2){t.source2=i.map.src}}if(e=="img"&&!t.poster){t.poster=i.map.src}}}).parse(e);t.source1=t.source1||t.src||t.data;t.source2=t.source2||"";t.poster=t.poster||"";return t}function s(t){if(t.getAttribute("data-mce-object")){return n(e.serializer.serialize(t,{selection:true}))}return{}}function u(e,t,i){var r=new tinymce.html.Writer;var a=0,o;function c(e,t){var i,r,a,o;for(i in t){a=""+t[i];if(e.map[i]){r=e.length;while(r--){o=e[r];if(o.name==i){if(a){e.map[i]=a;o.value=a}else{delete e.map[i];e.splice(r,1)}}}}else if(a){e.push({name:i,value:a});e.map[i]=a}}}new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:"script,noscript",comment:function(e){r.comment(e)},cdata:function(e){r.cdata(e)},text:function(e,t){r.text(e,t)},start:function(e,n,s){switch(e){case"video":case"object":case"embed":case"img":case"iframe":c(n,{width:t.width,height:t.height});break}if(i){switch(e){case"video":c(n,{poster:t.poster,src:""});if(t.source2){c(n,{src:""})}break;case"iframe":c(n,{src:t.source1});break;case"source":a++;if(a<=2){c(n,{src:t["source"+a],type:t["source"+a+"mime"]});if(!t["source"+a]){return}}break;case"img":if(!t.poster){return}o=true;break}}r.start(e,n,s)},end:function(e){if(e=="video"&&i){for(var n=1;n<=2;n++){if(t["source"+n]){var s=[];s.map={};if(a<n){c(s,{src:t["source"+n],type:t["source"+n+"mime"]});r.start("source",s,true)}}}}if(t.poster&&e=="object"&&i&&!o){var u=[];u.map={};c(u,{src:t.poster,width:t.width,height:t.height});r.start("img",u,true)}r.end(e)}},new tinymce.html.Schema({})).parse(e);return r.getContent()}e.on("ResolveName",function(e){var t;if(e.target.nodeType==1&&(t=e.target.getAttribute("data-mce-object"))){e.name=t}});e.on("preInit",function(){var t=e.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});e.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var i=e.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){i[e]={}});e.parser.addNodeFilter("iframe,video,audio,object,embed",function(t,i){var r=t.length,a,o,c,n,s,u,m;while(r--){o=t[r];c=new tinymce.html.Node("img",1);c.shortEnded=true;u=o.attributes;a=u.length;while(a--){n=u[a].name;s=u[a].value;if(n!=="width"&&n!=="height"&&n!=="style"){if(n=="data"||n=="src"){s=e.convertURL(s,n)}c.attr("data-mce-p-"+n,s)}}m=o.firstChild&&o.firstChild.value;if(m){c.attr("data-mce-html",escape(m));c.firstChild=null}c.attr({width:o.attr("width")||"300",height:o.attr("height")||(i=="audio"?"30":"150"),style:o.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":i,"class":"mce-object mce-object-"+i});o.replace(c)}});e.serializer.addAttributeFilter("data-mce-object",function(e,t){var i=e.length,r,a,o,c,n,s;while(i--){r=e[i];a=new tinymce.html.Node(r.attr(t),1);if(r.attr(t)!="audio"){a.attr({width:r.attr("width"),height:r.attr("height")})}a.attr({style:r.attr("style")});c=r.attributes;o=c.length;while(o--){var u=c[o].name;if(u.indexOf("data-mce-p-")===0){a.attr(u.substr(11),c[o].value)}}n=r.attr("data-mce-html");if(n){s=new tinymce.html.Node("#text",3);s.raw=true;s.value=unescape(n);a.append(s)}r.replace(a)}})});e.on("ObjectSelected",function(e){if(e.target.getAttribute("data-mce-object")=="audio"){e.preventDefault()}});e.on("objectResized",function(e){var t=e.target,i;if(t.getAttribute("data-mce-object")){i=t.getAttribute("data-mce-html");if(i){i=unescape(i);t.setAttribute("data-mce-html",escape(u(i,{width:e.width,height:e.height})))}}});e.addButton("media",{tooltip:"Insert/edit video",onclick:a,stateSelector:"img[data-mce-object=video]"});e.addMenuItem("media",{icon:"media",text:"Insert video",onclick:a,context:"insert",prependToContext:true})});